<!DOCTYPE html>
<html lang="nl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Invasieve Exoten Herkenner</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }

        /* Base styles for the overlay containers */
        .overlay-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(243, 244, 246, 0.95);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 50;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.5s ease-in-out;
        }

        .overlay-container.show {
            opacity: 1;
            pointer-events: auto;
        }

        .content-card {
            background-color: white;
            border-radius: 1.5rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            padding: 2rem;
            max-width: 28rem;
            width: calc(100% - 2rem);
            margin: 1rem;
            text-align: center;
            transform: translateY(20px);
            transition: transform 0.5s ease-in-out;
        }

        .overlay-container.show .content-card {
            transform: translateY(0);
        }
    </style>
</head>
<body class="flex items-center justify-center min-h-screen p-4">
    <div class="bg-white rounded-2xl shadow-xl p-8 max-w-md w-full max-h-screen overflow-y-auto text-center">
        <!-- Logo and title -->
        <div class="flex items-center justify-center space-x-2 mb-4">
            <!-- Nieuw blad logo gebaseerd op de geüploade afbeelding -->
            <svg class="w-8 h-8 text-green-600" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M12.981 2.227c-.413-.239-.933-.239-1.346 0L5.342 6.551C4.929 6.79 4.671 7.228 4.671 7.7V17c0 .472.258.91.671 1.149l6.293 3.636c.413.239.933.239 1.346 0l6.293-3.636c.413-.239.671-.677.671-1.149V7.7c0-.472-.258-.91-.671-.149L12.981 2.227z" stroke="#16a34a" stroke-width="2" stroke-linejoin="round"/>
                <path d="M12 7.5L12 17M12 10L16.293 12.441M12 10L7.707 12.441" stroke="#16a34a" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
            <h1 class="text-3xl font-bold text-green-600">Exota</h1>
        </div>
        
        <p class="text-lg text-gray-600 mb-4">Invasieve exoten herkenner</p>
        <p class="text-gray-500 mb-6">Neem een foto of selecteer een afbeelding om een plant te herkennen.</p>

        <!-- Container for photo capture/upload -->
        <div id="capture-container" class="flex flex-col items-center justify-center space-y-4 transition-all duration-500 ease-in-out">
            <input type="file" id="image-input" accept="image/*" class="hidden">
            <button id="camera-button" class="bg-green-600 text-white font-medium py-3 px-6 rounded-full shadow-lg hover:bg-green-700 transition duration-300 transform hover:scale-105 active:scale-95">
                Neem een Foto
            </button>
            <button id="upload-button" class="bg-gray-200 text-gray-700 font-medium py-3 px-6 rounded-full hover:bg-gray-300 transition duration-300">
                Selecteer Afbeelding
            </button>
        </div>

        <!-- Image preview and loading state -->
        <div id="preview-container" class="hidden flex flex-col items-center mt-6 transition-all duration-500 ease-in-out">
            <img id="image-preview" src="#" alt="Geselecteerde afbeelding" class="rounded-xl object-cover w-full max-h-64 mb-4 border border-gray-300">
            <div id="loading-spinner" class="hidden flex-col items-center justify-center space-y-2">
                 <svg class="animate-spin h-8 w-8 text-green-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                <p class="text-gray-600">Analyseren...</p>
            </div>
        </div>
        
        <!-- Error and retry section -->
        <div id="error-state-container" class="hidden flex flex-col items-center justify-center mt-6 space-y-4 transition-all duration-500 ease-in-out">
            <p id="error-message" class="text-red-500"></p>
            <button id="retry-button" class="bg-gray-200 text-gray-700 font-medium py-2 px-4 rounded-full hover:bg-gray-300 transition duration-300 transform hover:scale-105 active:scale-95">
                Opnieuw
            </button>
        </div>
    </div>

    <!-- Result overlay section -->
    <div id="results-overlay" class="overlay-container">
        <div id="results-container" class="content-card">
            <h2 class="text-xl font-semibold text-gray-800 mb-4">Herkenning Resultaat</h2>
            <div class="space-y-4 text-left">
                <div>
                    <p class="text-gray-600 font-medium">Soort:</p>
                    <p id="species-result" class="text-gray-900 font-bold text-lg">Onbekend</p>
                </div>
                <div>
                    <p class="text-gray-600 font-medium">Zekerheid:</p>
                    <p id="certainty-result" class="text-gray-900 font-bold text-lg">0%</p>
                </div>
                <div>
                    <p id="invasive-label" class="text-gray-600 font-medium">Invasieve Exoot:</p>
                    <p id="invasive-result" class="text-lg font-bold">
                        <span id="invasive-badge" class="px-3 py-1 rounded-full text-white"></span>
                    </p>
                </div>
            </div>
            <div id="gemini-buttons" class="mt-6 flex flex-col sm:flex-row gap-4">
                <button id="retry-button-results" class="flex-1 bg-gray-200 text-gray-700 font-medium py-2 px-4 rounded-full hover:bg-gray-300 transition duration-300 transform hover:scale-105 active:scale-95">
                    Opnieuw
                </button>
                 <button id="what-now-button" class="hidden flex-1 bg-red-500 text-white font-medium py-2 px-4 rounded-full shadow-lg hover:bg-red-600 transition duration-300 transform hover:scale-105 active:scale-95">
                    Wat nu?
                </button>
            </div>
        </div>
    </div>

    <!-- Gemini result overlay section -->
    <div id="gemini-overlay" class="overlay-container">
        <div id="gemini-result-container" class="content-card text-left">
            <h2 id="gemini-title" class="text-xl font-semibold text-gray-800 mb-4">Wat nu?</h2>
            <div id="gemini-content" class="text-gray-700 whitespace-pre-wrap space-y-2">
                <p class="font-semibold text-gray-800">Hier zijn de volgende stappen bij de vondst van een invasieve exoot:</p>
                <div class="space-y-1">
                    <div class="flex items-start space-x-2">
                        <span class="text-green-600 font-bold text-lg">1.</span>
                        <p class="text-gray-700">Controleer je vondst. Neem eventueel een tweede foto ter controle.</p>
                    </div>
                    <div class="flex items-start space-x-2">
                        <span class="text-green-600 font-bold text-lg">2.</span>
                        <p class="text-gray-700">Als je zeker bent van de vondst, is het belangrijk om deze te melden bij een officiële instantie.</p>
                    </div>
                    <div class="flex items-start space-x-2">
                        <span class="text-green-600 font-bold text-lg">3.</span>
                        <p class="text-gray-700">Ga naar de NVWA-website voor meer informatie over het melden en bestrijden van invasieve exoten.</p>
                    </div>
                </div>
            </div>
            <div class="mt-4 text-center space-y-4">
                <button id="nvwa-button" class="inline-block bg-blue-500 text-white font-medium py-2 px-4 rounded-full hover:bg-blue-600 transition duration-300">
                    NVWA-website
                </button>
                <button id="back-button" class="inline-block bg-gray-200 text-gray-700 font-medium py-2 px-4 rounded-full hover:bg-gray-300 transition duration-300">
                    Terug
                </button>
            </div>
        </div>
    </div>

    <!-- JavaScript for app logic -->
    <script>
        // Get references to all necessary UI elements
        const imageInput = document.getElementById('image-input');
        const cameraButton = document.getElementById('camera-button');
        const uploadButton = document.getElementById('upload-button');
        const captureContainer = document.getElementById('capture-container');
        const previewContainer = document.getElementById('preview-container');
        const imagePreview = document.getElementById('image-preview');
        const loadingSpinner = document.getElementById('loading-spinner');
        const errorStateContainer = document.getElementById('error-state-container');
        const errorMessage = document.getElementById('error-message');
        const retryButton = document.getElementById('retry-button');

        const resultsOverlay = document.getElementById('results-overlay');
        const resultsContainer = document.getElementById('results-container');
        const speciesResult = document.getElementById('species-result');
        const certaintyResult = document.getElementById('certainty-result');
        const invasiveResult = document.getElementById('invasive-badge');
        const retryButtonResults = document.getElementById('retry-button-results');
        const whatNowButton = document.getElementById('what-now-button');

        const geminiOverlay = document.getElementById('gemini-overlay');
        const geminiResultContainer = document.getElementById('gemini-result-container');
        const geminiTitle = document = document.getElementById('gemini-title');
        const geminiContent = document.getElementById('gemini-content');
        const backButton = document.getElementById('back-button');
        const nvwaButton = document.getElementById('nvwa-button');
        
        // BELANGRIJK: De geheime sleutel wordt hier ingevuld tijdens het bouwproces.
        // Omdat de automatische invoeging mogelijk niet werkt, kun je je sleutel hier handmatig plakken.
        const WEBHOOK_SECRET = 'keyexotaxxxonfa8jh73urjtiujgumh7834yt78hwuigh83h47thuegnuihg3807thg8h30t37h8whguin037tmjgugp38t743hjtmegu3h7t3ht8ghusgh3780ht78mh3guh377ht478hr28qr7nqg26gb6d72x8jp9mtj485j8t9rmh28r72g6endbyubdg6712gbe637';
        
        const N8N_WEBHOOK_URL = 'https://n8n.smrt1.nl/webhook/a0fd40e1-ac57-44e1-8335-6e9d7a137482';
        
        // Gemini API configuration
        const API_KEY = "";
        const API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${API_KEY}`;
        
        // Functie om de app-status te resetten met een fade-out animatie
        function resetAppState() {
            resultsOverlay.classList.remove('show');
            geminiOverlay.classList.remove('show');
            errorStateContainer.classList.add('hidden');
            previewContainer.classList.add('hidden');
            captureContainer.classList.remove('hidden');
            imageInput.value = '';
        }

        // Event listener voor de "Neem een Foto" knop
        cameraButton.addEventListener('click', () => {
            imageInput.setAttribute('capture', 'camera');
            imageInput.click();
        });

        // Event listener voor de "Selecteer Afbeelding" knop
        uploadButton.addEventListener('click', () => {
            imageInput.removeAttribute('capture');
            imageInput.click();
        });

        // Event listener voor wanneer een afbeelding is geselecteerd
        imageInput.addEventListener('change', async (event) => {
            const file = event.target.files[0];
            if (!file) {
                return;
            }
            
            captureContainer.classList.add('hidden');
            previewContainer.classList.remove('hidden');
            loadingSpinner.classList.remove('hidden');

            const reader = new FileReader();
            reader.onload = (e) => {
                imagePreview.src = e.target.result;
            };
            reader.readAsDataURL(file);

            const formData = new FormData();
            formData.append('file', file);
            
            if (WEBHOOK_SECRET.includes('PLAK JE GEHEIME SLEUTEL HIER') || !WEBHOOK_SECRET) {
                const errorMsg = 'De WEBHOOK_SECRET is niet ingesteld. Plak je sleutel handmatig in de code en probeer het opnieuw.';
                console.error(errorMsg);
                loadingSpinner.classList.add('hidden');
                errorStateContainer.classList.remove('hidden');
                errorMessage.textContent = errorMsg;
                return;
            }

            console.log('Gebruikt webhook URL:', N8N_WEBHOOK_URL);
            console.log('Gebruikt WEBHOOK_SECRET:', '***** (ingesteld)');

            try {
                // Hier wordt de HTTP-aanvraag naar de n8n webhook gestuurd.
                // De 'X-API-Key' header is cruciaal voor authenticatie.
                const response = await fetch(N8N_WEBHOOK_URL, {
                    method: 'POST',
                    body: formData,
                    headers: {
                        'X-API-Key': WEBHOOK_SECRET
                    }
                });

                if (!response.ok) {
                    // Als de respons niet OK is (bijv. 401 Unauthorized), gooi dan een fout.
                    // Dit betekent dat de header mogelijk niet correct is.
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();
                const output = data.output;
                
                speciesResult.textContent = output.Soort || 'Onbekend';
                let certaintyValue = output.Betrouwbaarheid || "0%";
                if (typeof certaintyValue === 'string') {
                    certaintyValue = parseInt(certaintyValue.replace('%', ''));
                }
                certaintyResult.textContent = `${certaintyValue}%`;

                if (output.Soort === 'Plant is onbekend') {
                     invasiveResult.textContent = 'Nee';
                    invasiveResult.classList.remove('bg-red-500');
                    invasiveResult.classList.add('bg-green-500');
                    whatNowButton.classList.add('hidden');
                } else if (output.Exoot === 'Ja' || output.Exoot === 'Betreft waarschijnlijk invasieve exoot' || output.Exoot === 'Waarschijnlijk') {
                    invasiveResult.textContent = 'Ja';
                    invasiveResult.classList.remove('bg-gray-500');
                    invasiveResult.classList.add('bg-red-500');
                    whatNowButton.classList.remove('hidden');
                    whatNowButton.classList.remove('bg-blue-500');
                    whatNowButton.classList.add('bg-red-500');

                } else {
                    invasiveResult.textContent = 'Nee';
                    invasiveResult.classList.remove('bg-red-500');
                    invasiveResult.classList.add('bg-green-500');
                    whatNowButton.classList.add('hidden');
                }
                
                loadingSpinner.classList.add('hidden');
                resultsOverlay.classList.add('show');

            } catch (error) {
                console.error('Error during image upload:', error);
                loadingSpinner.classList.add('hidden');
                errorStateContainer.classList.remove('hidden');
                errorMessage.textContent = `Er is een netwerkfout opgetreden. Controleer de API-sleutel en probeer het later opnieuw. Details: ${error.message}`;
                resultsOverlay.classList.add('hidden');
            }
        });

        // Event listeners voor alle "Opnieuw" knoppen
        retryButton.addEventListener('click', resetAppState);
        retryButtonResults.addEventListener('click', resetAppState);

        // Event listener voor de "Wat nu?" knop
        whatNowButton.addEventListener('click', () => {
            resultsOverlay.classList.remove('show');
            geminiOverlay.classList.add('show');
        });
        backButton.addEventListener('click', resetAppState);
        nvwaButton.addEventListener('click', () => {
            window.open('https://www.nvwa.nl/onderwerpen/invasieve-exoten/invasieve-planten/invasieve-landplanten/melden-en-bestrijden-invasieve-landplanten', '_blank');
        });
    </script>
</body>
</html>
